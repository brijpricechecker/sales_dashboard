<!DOCTYPE html>
<html>
  <head>
    <title>Sales Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .summary-boxes {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }
      .box {
        padding: 20px;
        border-radius: 10px;
        background-color: #f0f0f0;
        flex: 1;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      canvas {
        max-width: 100%;
      }
    </style>
  </head>
  <body>
    <h1>Sales Dashboard</h1>

    <label for="startDate">Start Date:</label>
    <input type="date" id="startDate" />
    <label for="endDate">End Date:</label>
    <input type="date" id="endDate" />
    <label for="supplier">Supplier:</label>
    <select id="supplier"></select>
    <button onclick="loadData()">Apply Filters</button>

    <div class="summary-boxes">
      <div class="box" id="salesBox">Total Sales: ₱0</div>
      <div class="box" id="purchasesBox">Total Purchases: 0</div>
      <div class="box" id="revenueBox">Total Revenue: ₱0</div>
    </div>

    <canvas id="revenueChart" height="100"></canvas>
    <canvas id="supplierPieChart" height="100"></canvas>

    <script>
      let revenueChart, supplierPieChart;

      function loadData() {
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;
        const supplier = document.getElementById("supplier").value;

        const params = new URLSearchParams({
          startDate,
          endDate,
          supplier
        });

        fetch("https://script.google.com/macros/s/AKfycbyNhFl8nWDfs7LQLWhhbV9-KUdENX-9aqT8W_jr4-zNEjBqeIKXwU9hWRuoTXaiHmJ8/exec" + params)
          .then(res => res.json())
          .then(data => {
            updateSummary(data.totals);
            renderRevenueChart(data.timeline);
            renderPieChart(data.salesBySupplier);
            populateSupplierDropdown(data.allSuppliers);
          });
      }

      function updateSummary(totals) {
        document.getElementById("salesBox").innerText = `Total Sales: ₱${totals.sales.toLocaleString()}`;
        document.getElementById("purchasesBox").innerText = `Total Purchases: ${totals.purchases}`;
        document.getElementById("revenueBox").innerText = `Total Revenue: ₱${totals.revenue.toLocaleString()}`;
      }

      function renderRevenueChart(timeline) {
        const labels = Object.keys(timeline).sort();
        const revenueData = labels.map(date => timeline[date].revenue);

        const ctx = document.getElementById("revenueChart").getContext("2d");
        if (revenueChart) revenueChart.destroy();

        revenueChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Revenue',
              data: revenueData,
              backgroundColor: 'rgba(54, 162, 235, 0.7)'
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: 'Revenue Over Time'
              }
            }
          }
        });
      }

      function renderPieChart(data) {
        const labels = Object.keys(data);
        const values = labels.map(label => data[label]);

        const ctx = document.getElementById("supplierPieChart").getContext("2d");
        if (supplierPieChart) supplierPieChart.destroy();

        supplierPieChart = new Chart(ctx, {
          type: 'pie',
          data: {
            labels,
            datasets: [{
              label: 'Sales by Supplier',
              data: values,
              backgroundColor: labels.map((_, i) =>
                `hsl(${i * 30 % 360}, 70%, 60%)`
              )
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: 'Sales Distribution by Supplier'
              }
            }
          }
        });
      }

      function populateSupplierDropdown(suppliers) {
        const dropdown = document.getElementById("supplier");
        const current = dropdown.value;
        dropdown.innerHTML = '<option value="">All Suppliers</option>';
        suppliers.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s;
          opt.text = s;
          dropdown.appendChild(opt);
        });
        dropdown.value = current;
      }

      // Initial load
      loadData();
    </script>
  </body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Inventory Dashboard</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    .kpi-box { display: inline-block; width: 30%; padding: 10px; margin: 10px; background: #f0f0f0; border-radius: 8px; text-align: center; }
    .section { margin-top: 30px; }
    select[multiple] { width: 300px; height: 100px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  </style>
</head>
<body>
  <h1>Inventory Dashboard</h1>

  <label>Start Date: <input type="date" id="startDate"></label>
  <label>End Date: <input type="date" id="endDate"></label>
  <label>Suppliers:</label>
  <select id="supplierFilter" multiple></select>
  <button onclick="loadDashboard()">Load Dashboard</button>
  <button onclick="selectAllSuppliers()">Select All</button>

  <div class="section">
    <div class="kpi-box" id="kpiSales">Sales: ₱0.00</div>
    <div class="kpi-box" id="kpiPurchases">Purchases: ₱0.00</div>
    <div class="kpi-box" id="kpiRevenue">Revenue: ₱0.00</div>
  </div>

  <div class="section">
    <div id="timelineChart" style="width: 100%; height: 400px;"></div>
  </div>

  <div class="section">
    <div id="salesPurchasesChart" style="width: 100%; height: 400px;"></div>
    <div id="revenueBySupplierChart" style="width: 100%; height: 400px;"></div>
  </div>

  <div class="section">
    <h3>Top Sales (by Quantity)</h3>
    <table id="topSalesTable"><thead><tr><th>Item</th><th>Qty</th><th>Sales</th></tr></thead><tbody></tbody></table>

    <h3>Top Revenue (by Revenue)</h3>
    <table id="topRevenueTable"><thead><tr><th>Item</th><th>Qty</th><th>Revenue</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="section">
    <h3>Supplier Summary</h3>
    <table id="supplierSummary"><thead><tr><th>Supplier</th><th>Sales</th><th>Purchases</th></tr></thead><tbody></tbody></table>
  </div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxQ6X01gOsnohYlGqQ8dHDZDVmBEuAybaP7oqTr9HQX1HOE0apmaH9CAey9DqR4G10d/exec';

    google.charts.load('current', { packages: ['corechart'] });

    function loadDashboard() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const selectedSuppliers = Array.from(document.getElementById('supplierFilter').selectedOptions).map(opt => opt.value).join(',');

      const url = `${scriptURL}?startDate=${startDate}&endDate=${endDate}&supplier=${encodeURIComponent(selectedSuppliers)}`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (data.error) return alert('Error: ' + data.error);

          updateKPIs(data.totals);
          drawTimeline(data.timeline);
          drawSalesPurchases(data.monthly);
          drawRevenueBySupplier(data.revenueBySupplier);
          populateTable('topSalesTable', data.topSales, ['name', 'quantity', 'sales']);
          populateTable('topRevenueTable', data.topRevenue, ['name', 'quantity', 'revenue']);
          populateTable('supplierSummary', data.supplierSummary, ['supplier', 'sales', 'purchases']);
          populateSupplierFilter(data.allSuppliers, selectedSuppliers.split(','));
        })
        .catch(err => alert('Failed to load dashboard.\n' + err));
    }

    function updateKPIs(totals) {
      document.getElementById('kpiSales').textContent = 'Sales: ₱' + totals.sales;
      document.getElementById('kpiPurchases').textContent = 'Purchases: ₱' + totals.purchases;
      document.getElementById('kpiRevenue').textContent = 'Revenue: ₱' + totals.revenue;
    }

    function drawTimeline(timelineData) {
      google.charts.setOnLoadCallback(() => {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Date');
        data.addColumn('number', 'Sales');
        data.addColumn('number', 'Revenue');

        timelineData.forEach(d => {
          data.addRow([d.date, parseFloat(d.sales.replace(/,/g, '')), parseFloat(d.revenue.replace(/,/g, ''))]);
        });

        const chart = new google.visualization.LineChart(document.getElementById('timelineChart'));
        chart.draw(data, {
          title: 'Sales and Revenue Over Time',
          curveType: 'function',
          legend: { position: 'bottom' }
        });
      });
    }

    function drawSalesPurchases(monthly) {
      const data = new google.visualization.DataTable();
      data.addColumn('string', 'Month');
      data.addColumn('number', 'Sales');
      data.addColumn('number', 'Purchases');

      Object.entries(monthly).forEach(([month, val]) => {
        data.addRow([month, val.sales, val.purchases]);
      });

      const chart = new google.visualization.ColumnChart(document.getElementById('salesPurchasesChart'));
      chart.draw(data, {
        title: 'Monthly Sales vs Purchases',
        bars: 'vertical',
        legend: { position: 'top' },
        height: 400
      });
    }

    function drawRevenueBySupplier(dataList) {
      const data = new google.visualization.DataTable();
      data.addColumn('string', 'Supplier');
      data.addColumn('number', 'Revenue');

      dataList.forEach(d => {
        data.addRow([d.supplier, parseFloat(d.revenue.replace(/,/g, ''))]);
      });

      const chart = new google.visualization.PieChart(document.getElementById('revenueBySupplierChart'));
      chart.draw(data, {
        title: 'Revenue by Supplier',
        is3D: true
      });
    }

    function populateTable(tableId, rows, fields) {
      const tbody = document.getElementById(tableId).querySelector('tbody');
      tbody.innerHTML = '';
      rows.forEach(row => {
        const tr = document.createElement('tr');
        fields.forEach(field => {
          const td = document.createElement('td');
          td.textContent = row[field];
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function populateSupplierFilter(suppliers, selected = []) {
      const select = document.getElementById('supplierFilter');
      select.innerHTML = '';
      suppliers.forEach(s => {
        const option = document.createElement('option');
        option.value = s;
        option.textContent = s;
        if (selected.includes(s)) option.selected = true;
        select.appendChild(option);
      });
    }

    function selectAllSuppliers() {
      const select = document.getElementById('supplierFilter');
      Array.from(select.options).forEach(opt => opt.selected = true);
    }

    window.onload = () => {
      const today = new Date();
      const weekAgo = new Date();
      weekAgo.setDate(today.getDate() - 7);
      document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
      document.getElementById('endDate').value = today.toISOString().split('T')[0];
      loadDashboard();
    };
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Inventory Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: 10px; }
    .filters, .metrics, .charts, .top-items { margin-bottom: 20px; }
    label { margin-right: 10px; }
    canvas { max-width: 100%; }
    .supplier-checkboxes { max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; width: 250px; }
  </style>
</head>
<body>
  <h1>Inventory Dashboard</h1>

  <div class="filters">
    <label>Start Date: <input type="date" id="startDate"></label>
    <label>End Date: <input type="date" id="endDate"></label>
    <div>
      <label>Suppliers:</label>
      <div id="supplierCheckboxes" class="supplier-checkboxes"></div>
    </div>
    <button onclick="loadData()">Apply Filters</button>
  </div>

  <div class="metrics">
    <h2>Summary</h2>
    <p>Sales: ₱<span id="sales"></span></p>
    <p>Purchases: ₱<span id="purchases"></span></p>
    <p>Revenue: ₱<span id="revenue"></span></p>
  </div>

  <div class="charts">
    <h2>Timeline</h2>
    <canvas id="lineChart"></canvas>

    <h2>Monthly Sales vs Purchases</h2>
    <canvas id="barChart"></canvas>

    <h2>Revenue by Supplier</h2>
    <canvas id="pieChart"></canvas>
  </div>

  <div class="top-items">
    <h2>Top 10 Items by Sales</h2>
    <ul id="topSalesList"></ul>

    <h2>Top 10 Items by Revenue</h2>
    <ul id="topRevenueList"></ul>
  </div>

  <script>
    let lineChart, barChart, pieChart;

    async function loadData() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const supplierCheckboxes = document.querySelectorAll('#supplierCheckboxes input[type="checkbox"]:checked');
      const suppliers = Array.from(supplierCheckboxes).map(cb => cb.value).join(',');

      const query = `?startDate=${startDate}&endDate=${endDate}&supplier=${suppliers}`;
      const response = await fetch('https://script.google.com/macros/s/AKfycbyNhFl8nWDfs7LQLWhhbV9-KUdENX-9aqT8W_jr4-zNEjBqeIKXwU9hWRuoTXaiHmJ8/exec' + query);
      const data = await response.json();

      document.getElementById('sales').textContent = data.totals.sales;
      document.getElementById('purchases').textContent = data.totals.purchases;
      document.getElementById('revenue').textContent = data.totals.revenue;

      renderLineChart(data.timeline);
      renderBarChart(data.monthly);
      renderPieChart(data.revenueBySupplier);
      renderTopItems('topSalesList', data.topSales, 'quantity');
      renderTopItems('topRevenueList', data.topRevenue, 'revenue');
      renderSupplierCheckboxes(data.allSuppliers);
    }

    function renderLineChart(data) {
      const labels = Object.keys(data).sort((a, b) => new Date(a) - new Date(b));
      const sales = labels.map(k => data[k].sales);
      const revenue = labels.map(k => data[k].revenue);

      const ctx = document.getElementById('lineChart').getContext('2d');
      if (lineChart) lineChart.destroy();
      lineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels.map(date => new Date(date).toLocaleDateString('default', { month: 'short', day: 'numeric' })),
          datasets: [
            { label: 'Sales', data: sales, borderColor: '#2196f3', fill: false },
            { label: 'Revenue', data: revenue, borderColor: '#f44336', fill: false }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true },
            x: { ticks: { autoSkip: true, maxTicksLimit: 15 } }
          }
        }
      });
    }

    function renderBarChart(data) {
      const labels = Object.keys(data).sort(); // Assumes 'YYYY-MM' format
      const sales = labels.map(k => data[k].sales);
      const purchases = labels.map(k => data[k].purchases);

      const ctx = document.getElementById('barChart').getContext('2d');
      if (barChart) barChart.destroy();
      barChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Sales', data: sales, backgroundColor: '#4caf50' },
            { label: 'Purchases', data: purchases, backgroundColor: '#ff9800' }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function renderPieChart(data) {
      const labels = data.map(d => d.supplier);
      const revenues = data.map(d => d.revenue);

      const ctx = document.getElementById('pieChart').getContext('2d');
      if (pieChart) pieChart.destroy();
      pieChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            data: revenues,
            backgroundColor: labels.map((_, i) => `hsl(${i * 360 / labels.length}, 70%, 60%)`)
          }]
        },
        options: { responsive: true }
      });
    }

    function renderTopItems(containerId, items, valueKey) {
      const list = document.getElementById(containerId);
      list.innerHTML = '';
      items.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.name} - ${item[valueKey]}`;
        list.appendChild(li);
      });
    }

    function renderSupplierCheckboxes(suppliers) {
      const container = document.getElementById('supplierCheckboxes');
      const selected = Array.from(container.querySelectorAll('input:checked')).map(cb => cb.value);
      container.innerHTML = '';
      suppliers.forEach(supplier => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = supplier;
        if (selected.includes(supplier)) checkbox.checked = true;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(supplier));
        container.appendChild(label);
        container.appendChild(document.createElement('br'));
      });
    }

    window.onload = loadData;
  </script>
</body>
</html>



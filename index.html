<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    #controls, #charts {
      margin: 10px;
    }
    #charts {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .chart-container {
      flex: 1;
      min-width: 450px;
      height: 400px;
    }
  </style>
</head>
<body>
  <div id="controls">
    <label for="startDate">Start Date:</label>
    <input type="date" id="startDate">
    <label for="endDate">End Date:</label>
    <input type="date" id="endDate">
    <label for="supplier">Supplier:</label>
    <select id="supplier" multiple></select>
    <button onclick="fetchData()">Apply</button>
  </div>

  <div id="charts">
    <div id="salesPurchasesChart" class="chart-container"></div>
  </div>

  <script>
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(fetchData);

    function fetchData() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const supplierSelect = document.getElementById('supplier');
      const selectedSuppliers = Array.from(supplierSelect.selectedOptions).map(o => o.value);

      const params = new URLSearchParams();
      if (startDate) params.append("startDate", startDate);
      if (endDate) params.append("endDate", endDate);
      if (selectedSuppliers.length) params.append("supplier", selectedSuppliers.join(','));

      fetch('https://script.google.com/macros/s/AKfycbxQ6X01gOsnohYlGqQ8dHDZDVmBEuAybaP7oqTr9HQX1HOE0apmaH9CAey9DqR4G10d/exec' + params.toString())
        .then(res => res.json())
        .then(drawCharts);
    }

    function drawCharts(data) {
      drawSalesPurchasesChart(data);
      updateSupplierDropdown(data.allSuppliers || []);
    }

    function drawSalesPurchasesChart(data) {
      const startDate = new Date(document.getElementById('startDate').value);
      const endDate = new Date(document.getElementById('endDate').value);
      const diffDays = (endDate - startDate) / (1000 * 60 * 60 * 24);

      let chartData = [['Date', 'Sales', 'Purchases']];
      const timeline = data.timeline || {};
      const monthly = data.monthly || {};

      if (diffDays <= 10) {
        // Daily
        Object.keys(timeline).sort().forEach(key => {
          const dateObj = safeDateParse(key);
          if (dateObj) {
            chartData.push([dateObj, timeline[key].sales || 0, timeline[key].purchases || 0]);
          }
        });
      } else if (diffDays <= 28) {
        // Weekly
        const weekMap = {};
        Object.keys(timeline).forEach(key => {
          const date = safeDateParse(key);
          if (!date) return;
          const weekKey = getWeekStart(date);
          if (!weekMap[weekKey]) weekMap[weekKey] = { sales: 0, purchases: 0 };
          weekMap[weekKey].sales += timeline[key].sales || 0;
          weekMap[weekKey].purchases += timeline[key].purchases || 0;
        });
        Object.keys(weekMap).sort().forEach(week => {
          chartData.push([new Date(week), weekMap[week].sales, weekMap[week].purchases]);
        });
      } else {
        // Monthly
        Object.keys(monthly).sort().forEach(month => {
          const dateObj = safeDateParse(month + '-01');
          if (dateObj) {
            chartData.push([dateObj, monthly[month].sales || 0, monthly[month].purchases || 0]);
          }
        });
      }

      const dataTable = google.visualization.arrayToDataTable(chartData);
      const options = {
        title: 'Sales vs Purchases',
        hAxis: { title: 'Date', format: 'MMM dd, yyyy' },
        vAxis: { title: 'Amount' },
        isStacked: false,
        seriesType: 'bars',
        legend: { position: 'top' },
        bar: { groupWidth: '50%' }
      };
      const chart = new google.visualization.ComboChart(document.getElementById('salesPurchasesChart'));
      chart.draw(dataTable, options);
    }

    function safeDateParse(input) {
      const date = new Date(input);
      if (isNaN(date.getTime())) {
        console.warn("Invalid date format:", input);
        return null;
      }
      return date;
    }

    function getWeekStart(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Monday
      const monday = new Date(d.setDate(diff));
      return monday.toISOString().split('T')[0];
    }

    function updateSupplierDropdown(suppliers) {
      const select = document.getElementById('supplier');
      const selected = Array.from(select.selectedOptions).map(o => o.value);
      select.innerHTML = '';
      suppliers.forEach(s => {
        const option = document.createElement('option');
        option.value = s;
        option.textContent = s;
        if (selected.includes(s)) option.selected = true;
        select.appendChild(option);
      });
    }
  </script>
</body>
</html>


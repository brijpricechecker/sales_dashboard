<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Inventory Dashboard</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }

    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .kpis {
      display: flex;
      justify-content: space-around;
      height: 12vh;
      margin-bottom: 10px;
    }

    .kpi {
      flex: 1;
      margin: 5px;
      background-color: #e3f2fd;
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: relative;
    }

    .kpi[data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 5px;
      border-radius: 4px;
      white-space: nowrap;
    }

    .charts, .tables {
      display: flex;
      justify-content: space-between;
      height: 40vh;
      margin-bottom: 10px;
    }

    .chart, .table {
      width: 49%;
      height: 100%;
      overflow: auto;
    }

    select[multiple] {
      height: 100px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="filters">
    <label>
      Date Mode:
      <select id="dateMode">
        <option value="monthly" selected>Monthly</option>
        <option value="daily">Daily</option>
        <option value="yearly">Yearly</option>
      </select>
    </label>

    <label id="startLabel" class="hidden">
      Start Date:
      <input type="date" id="startDate" />
    </label>

    <label id="endLabel" class="hidden">
      End Date:
      <input type="date" id="endDate" />
    </label>

    <label>
      Suppliers:
      <select id="supplierFilter" multiple></select>
    </label>
  </div>

  <div class="kpis">
    <div class="kpi" id="salesKPI" data-tooltip="Total Sales within selected period">Sales: ₱0.00</div>
    <div class="kpi" id="purchasesKPI" data-tooltip="Total Purchases within selected period">Purchases: ₱0.00</div>
    <div class="kpi" id="revenueKPI" data-tooltip="Total Revenue calculated from sales">Revenue: ₱0.00</div>
  </div>

  <div class="charts">
    <div id="timelineChart" class="chart"></div>
    <div id="supplierChart" class="chart"></div>
  </div>

  <div class="charts">
    <div id="comparisonChart" class="chart"></div>
    <div></div>
  </div>

  <div class="tables">
    <div class="table">
      <h3>Top 10 Sales</h3>
      <table id="topSalesTable" border="1" width="100%"></table>
    </div>
    <div class="table">
      <h3>Top 10 Revenue</h3>
      <table id="topRevenueTable" border="1" width="100%"></table>
    </div>
  </div>

  <script>
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(init);

    function init() {
      document.getElementById('dateMode').addEventListener('change', updateDateVisibility);
      document.getElementById('startDate').addEventListener('change', fetchData);
      document.getElementById('endDate').addEventListener('change', fetchData);
      document.getElementById('supplierFilter').addEventListener('change', fetchData);
      updateDateVisibility();
      fetchData();
    }

    function updateDateVisibility() {
      const mode = document.getElementById('dateMode').value;
      const show = mode === 'daily';
      document.getElementById('startLabel').classList.toggle('hidden', !show);
      document.getElementById('endLabel').classList.toggle('hidden', !show);
      fetchData();
    }

    function fetchData() {
      const mode = document.getElementById('dateMode').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      const suppliers = Array.from(document.getElementById('supplierFilter').selectedOptions)
        .map(opt => opt.value)
        .filter(val => val !== 'ALL');

      const params = new URLSearchParams({ mode });
      if (startDate) params.append('startDate', startDate);
      if (endDate) params.append('endDate', endDate);
      if (suppliers.length > 0) params.append('supplier', suppliers.join(','));


const baseUrl = "https://script.google.com/macros/s/AKfycbxQ6X01gOsnohYlGqQ8dHDZDVmBEuAybaP7oqTr9HQX1HOE0apmaH9CAey9DqR4G10d/exec";
fetch(`${baseUrl}?${params.toString()}`)
        .then(res => res.json())
        .then(data => renderDashboard(data));
    }

    function renderDashboard(data) {
      document.getElementById('salesKPI').innerText = 'Sales: ₱' + data.totals.sales;
      document.getElementById('purchasesKPI').innerText = 'Purchases: ₱' + data.totals.purchases;
      document.getElementById('revenueKPI').innerText = 'Revenue: ₱' + data.totals.revenue;

      renderSupplierFilter(data.allSuppliers);
      drawTimelineChart(data.timeline);
      drawSupplierChart(data.revenueBySupplier);
      drawComparisonChart(data.monthly);
      populateTable('topSalesTable', data.topSales, ['name', 'quantity', 'sales']);
      populateTable('topRevenueTable', data.topRevenue, ['name', 'quantity', 'revenue']);
    }

    function renderSupplierFilter(suppliers) {
      const sel = document.getElementById('supplierFilter');
      const current = Array.from(sel.selectedOptions).map(opt => opt.value);
      sel.innerHTML = '';
      const allOption = document.createElement('option');
      allOption.value = 'ALL';
      allOption.textContent = 'Select All';
      sel.appendChild(allOption);

      suppliers.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        sel.appendChild(opt);
      });

      if (current.length === 0 || current.includes('ALL')) {
        Array.from(sel.options).forEach(opt => opt.selected = true);
      } else {
        Array.from(sel.options).forEach(opt => {
          opt.selected = current.includes(opt.value);
        });
      }
    }

    function drawTimelineChart(data) {
      const rows = [['Date', 'Sales', 'Revenue']];
      for (let key in data) {
        rows.push([key, data[key].sales, data[key].revenue]);
      }
      const dt = google.visualization.arrayToDataTable(rows);
      const chart = new google.visualization.ColumnChart(document.getElementById('timelineChart'));
      chart.draw(dt, { title: 'Sales & Revenue Over Time', height: '100%' });
    }

    function drawSupplierChart(data) {
      const rows = [['Supplier', 'Revenue']];
      data.forEach(item => rows.push([item.supplier, item.revenue]));
      const dt = google.visualization.arrayToDataTable(rows);
      const chart = new google.visualization.PieChart(document.getElementById('supplierChart'));
      chart.draw(dt, { title: 'Revenue by Supplier', pieHole: 0.4, height: '100%' });
    }

    function drawComparisonChart(data) {
      const rows = [['Month', 'Sales', 'Purchases']];
      for (let key in data) {
        rows.push([key, data[key].sales, data[key].purchases]);
      }
      const dt = google.visualization.arrayToDataTable(rows);
      const chart = new google.visualization.ColumnChart(document.getElementById('comparisonChart'));
      chart.draw(dt, { title: 'Sales vs Purchases', height: '100%' });
    }

    function populateTable(id, data, columns) {
      const table = document.getElementById(id);
      table.innerHTML = '';
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      columns.forEach(col => {
        const th = document.createElement('th');
        th.textContent = col.toUpperCase();
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      data.forEach(row => {
        const tr = document.createElement('tr');
        columns.forEach(col => {
          const td = document.createElement('td');
          td.textContent = row[col];
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
    }
  </script>
</body>
</html>

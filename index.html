<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    #controls, #charts {
      margin: 10px;
    }
    #charts {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .chart-container {
      flex: 1;
      min-width: 450px;
      height: 400px;
    }
  </style>
</head>
<body>
  <div id="controls">
    <label for="startDate">Start Date:</label>
    <input type="date" id="startDate">
    <label for="endDate">End Date:</label>
    <input type="date" id="endDate">
    <label for="supplier">Supplier:</label>
    <select id="supplier" multiple></select>
    <button onclick="fetchData()">Apply</button>
  </div>

  <div id="charts">
    <div id="salesPurchasesChart" class="chart-container"></div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxQ6X01gOsnohYlGqQ8dHDZDVmBEuAybaP7oqTr9HQX1HOE0apmaH9CAey9DqR4G10d/exec'; // Replace with your actual deployed URL

    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(fetchData);

    function fetchData() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const supplierSelect = document.getElementById('supplier');
      const selectedSuppliers = Array.from(supplierSelect.selectedOptions).map(o => o.value);

      const params = new URLSearchParams();
      if (startDate) params.append("startDate", startDate);
      if (endDate) params.append("endDate", endDate);
      if (selectedSuppliers.length) params.append("supplier", selectedSuppliers.join(','));

      fetch(`${API_URL}?${params.toString()}`)
        .then(res => res.json())
        .then(drawCharts)
        .catch(err => console.error("Fetch error:", err));
    }

    function drawCharts(data) {
      updateSupplierDropdown(data.allSuppliers || []);
      drawSalesPurchasesChart(data);
    }

    function drawSalesPurchasesChart(data) {
      const startDate = new Date(document.getElementById('startDate').value);
      const endDate = new Date(document.getElementById('endDate').value);
      const diffDays = (endDate - startDate) / (1000 * 60 * 60 * 24);

      let chartData = [['Date', 'Sales', 'Purchases']];
      const timeline = data.timeline || {};
      const weekly = data.weekly || {};
      const monthly = data.monthly || {};

      if (diffDays <= 10) {
        // Daily
        Object.keys(timeline).sort().forEach(dateStr => {
          const date = new Date(dateStr);
          const sales = timeline[dateStr]?.sales || 0;
          const purchases = timeline[dateStr]?.purchases || 0;
          chartData.push([date, sales, purchases]);
        });
      } else if (diffDays <= 28) {
        // Weekly
        Object.keys(weekly).sort().forEach(dateStr => {
          const date = parseISOWeekString(dateStr);
          const sales = weekly[dateStr]?.sales || 0;
          const purchases = weekly[dateStr]?.purchases || 0;
          chartData.push([date, sales, purchases]);
        });
      } else {
        // Monthly
        Object.keys(monthly).sort().forEach(dateStr => {
          const date = new Date(dateStr + '-01');
          const sales = monthly[dateStr]?.sales || 0;
          const purchases = monthly[dateStr]?.purchases || 0;
          chartData.push([date, sales, purchases]);
        });
      }

      const dataTable = google.visualization.arrayToDataTable(chartData);
      const options = {
        title: 'Sales vs Purchases',
        hAxis: { title: 'Date', format: 'MMM d, yyyy' },
        vAxis: { title: 'Amount' },
        isStacked: false,
        seriesType: 'bars',
        legend: { position: 'top' },
        bar: { groupWidth: '50%' }
      };

      const chart = new google.visualization.ComboChart(document.getElementById('salesPurchasesChart'));
      chart.draw(dataTable, options);
    }

    function parseISOWeekString(isoWeekStr) {
      const [year, weekPart] = isoWeekStr.split('-W');
      const week = parseInt(weekPart, 10);
      const simple = new Date(year, 0, 1 + (week - 1) * 7);
      const dow = simple.getDay();
      const ISOweekStart = simple;
      if (dow <= 4) {
        ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
      } else {
        ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
      }
      return ISOweekStart;
    }

    function updateSupplierDropdown(suppliers) {
      const select = document.getElementById('supplier');
      const currentValues = Array.from(select.selectedOptions).map(opt => opt.value);
      select.innerHTML = '';
      suppliers.forEach(s => {
        const option = document.createElement('option');
        option.value = s;
        option.textContent = s;
        if (currentValues.includes(s)) option.selected = true;
        select.appendChild(option);
      });
    }
  </script>
</body>
</html>

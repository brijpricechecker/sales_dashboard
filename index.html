<!DOCTYPE html>
<html>
<head>
  <title>Inventory Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }

    label {
      font-weight: bold;
    }

    .dropdown {
      position: relative;
      display: inline-block;
      margin-bottom: 10px;
    }

    .dropbtn {
      padding: 8px 12px;
      cursor: pointer;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #fff;
      min-width: 200px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      z-index: 10;
    }

    .dropdown-content label {
      display: block;
      padding: 5px 10px;
      cursor: pointer;
    }

    .filter-section {
      margin-bottom: 15px;
    }

    .kpi {
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="filter-section">
    <label for="startDate">Start Date:</label>
    <input type="date" id="startDate">
    <label for="endDate">End Date:</label>
    <input type="date" id="endDate">

    <div class="dropdown">
      <button class="dropbtn" onclick="toggleDropdown()">Select Suppliers</button>
      <div id="supplierDropdown" class="dropdown-content"></div>
    </div>
    <button onclick="selectAllSuppliers()">Select All</button>
    <button onclick="loadDashboard()">Apply Filters</button>
  </div>

  <div class="kpi">
    <strong>Total Sales:</strong> <span id="totalSales">₱0.00</span><br>
    <strong>Total Purchases:</strong> <span id="totalPurchases">₱0.00</span><br>
    <strong>Total Revenue:</strong> <span id="totalRevenue">₱0.00</span>
  </div>

  <div id="timelineChart"></div>
  <div id="monthlyChart"></div>
  <div id="revenueBySupplierChart"></div>
  <div id="topSalesTable"></div>
  <div id="topRevenueTable"></div>
  <div id="supplierSummary"></div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxQ6X01gOsnohYlGqQ8dHDZDVmBEuAybaP7oqTr9HQX1HOE0apmaH9CAey9DqR4G10d/exec'; // Your actual backend URL

    function toggleDropdown() {
      const dropdown = document.getElementById('supplierDropdown');
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }

    function populateSupplierFilter(suppliers, selected = []) {
      const dropdown = document.getElementById('supplierDropdown');
      dropdown.innerHTML = '';
      suppliers.forEach(supplier => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = supplier;
        checkbox.checked = selected.length === 0 || selected.includes(supplier);
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(" " + supplier));
        dropdown.appendChild(label);
      });
    }

    function getSelectedSuppliers() {
      const checkboxes = document.querySelectorAll('#supplierDropdown input[type="checkbox"]');
      return Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    }

    function selectAllSuppliers() {
      document.querySelectorAll('#supplierDropdown input[type="checkbox"]').forEach(cb => cb.checked = true);
    }

    function formatCurrency(value) {
      return '₱' + Number(value).toLocaleString('en-PH', { minimumFractionDigits: 2 });
    }

    function updateKPIs(totals) {
      document.getElementById('totalSales').textContent = totals.sales;
      document.getElementById('totalPurchases').textContent = totals.purchases;
      document.getElementById('totalRevenue').textContent = totals.revenue;
    }

    function loadDashboard() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const selectedSuppliers = getSelectedSuppliers();

      const url = `${scriptURL}?startDate=${startDate}&endDate=${endDate}&supplier=${encodeURIComponent(JSON.stringify(selectedSuppliers))}`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (data.error) return alert('Error: ' + data.error);

          updateKPIs(data.totals);
          drawTimeline(data.timeline);
          drawSalesPurchases(data.monthly);
          drawRevenueBySupplier(data.revenueBySupplier);
          populateTable('topSalesTable', data.topSales, ['name', 'quantity', 'sales']);
          populateTable('topRevenueTable', data.topRevenue, ['name', 'quantity', 'revenue']);
          populateTable('supplierSummary', data.supplierSummary, ['supplier', 'sales', 'purchases']);
          populateSupplierFilter(data.allSuppliers); // Select All by default
          selectAllSuppliers(); // Set all as selected
        })
        .catch(err => {
          console.error('Error loading data:', err);
          alert('Failed to load dashboard data.');
        });
    }

    function populateTable(containerId, data, columns) {
      const container = document.getElementById(containerId);
      if (!data || data.length === 0) {
        container.innerHTML = '<p>No data available.</p>';
        return;
      }

      let html = '<table border="1" cellpadding="5" cellspacing="0"><thead><tr>';
      columns.forEach(col => html += `<th>${col}</th>`);
      html += '</tr></thead><tbody>';

      data.forEach(row => {
        html += '<tr>';
        columns.forEach(col => html += `<td>${row[col]}</td>`);
        html += '</tr>';
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // Placeholder functions for visual charts
    function drawTimeline(data) {
      document.getElementById('timelineChart').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
    }

    function drawSalesPurchases(data) {
      document.getElementById('monthlyChart').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
    }

    function drawRevenueBySupplier(data) {
      document.getElementById('revenueBySupplierChart').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
    }

    // Initialize with default dates and load dashboard
    window.onload = function () {
      document.getElementById('startDate').value = '2025-01-01';
      document.getElementById('endDate').value = new Date().toISOString().split('T')[0];
      loadDashboard();
    }
  </script>
</body>
</html>

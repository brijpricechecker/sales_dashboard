<!DOCTYPE html>
<html>
<head>
  <title>Inventory Dashboard</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    #controls {
      margin-bottom: 20px;
    }
    .section {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .chart-box, .table-box {
      width: 48%;
      background-color: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      min-height: 300px;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      width: 50%;
      border-radius: 10px;
    }
    .checkbox-container {
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div id="controls">
    <label for="startDate">Start Date:</label>
    <input type="date" id="startDate">
    <label for="endDate">End Date:</label>
    <input type="date" id="endDate">
    <button onclick="openSupplierModal()">Select Suppliers</button>
  </div>

  <div id="charts" class="section">
    <div id="salesPurchasesChart" class="chart-box"></div>
    <div id="revenueBySupplierChart" class="chart-box"></div>
  </div>

  <div class="section">
    <div id="topSalesTable" class="table-box"></div>
    <div id="topRevenueTable" class="table-box"></div>
  </div>

  <div id="supplierModal" class="modal">
    <div class="modal-content">
      <h3>Select Suppliers</h3>
      <div id="supplierCheckboxes" class="checkbox-container"></div>
    </div>
  </div>

  <script>
    google.charts.load('current', {'packages':['corechart', 'table']});
    let selectedSuppliers = [];

    document.getElementById("startDate").addEventListener("change", fetchData);
    document.getElementById("endDate").addEventListener("change", fetchData);

    function openSupplierModal() {
      document.getElementById("supplierModal").style.display = "block";
    }

    function closeSupplierModal() {
      document.getElementById("supplierModal").style.display = "none";
    }

    function updateSupplierDropdown(suppliers) {
      const container = document.getElementById("supplierCheckboxes");
      container.innerHTML = "";
      suppliers.forEach(supplier => {
        const label = document.createElement("label");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = supplier;
        checkbox.checked = selectedSuppliers.includes(supplier);
        checkbox.addEventListener("change", () => {
          if (checkbox.checked) {
            if (!selectedSuppliers.includes(supplier)) selectedSuppliers.push(supplier);
          } else {
            selectedSuppliers = selectedSuppliers.filter(s => s !== supplier);
          }
          fetchData();
        });
        label.appendChild(checkbox);
        label.append(" " + supplier);
        container.appendChild(label);
        container.appendChild(document.createElement("br"));
      });
      closeSupplierModal();
    }

    function fetchData() {
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      const params = new URLSearchParams();
      if (startDate) params.append("startDate", startDate);
      if (endDate) params.append("endDate", endDate);
      if (selectedSuppliers.length) params.append("supplier", selectedSuppliers.join(","));

      fetch("https://script.google.com/macros/s/AKfycbxQ6X01gOsnohYlGqQ8dHDZDVmBEuAybaP7oqTr9HQX1HOE0apmaH9CAey9DqR4G10d/exec" + params.toString())
        .then(res => res.json())
        .then(data => {
          drawSalesPurchasesChart(data);
          drawRevenueBySupplierChart(data);
          drawTopSalesTable(data.topSales);
          drawTopRevenueTable(data.topRevenue);
          updateSupplierDropdown(data.allSuppliers || []);
        });
    }

    function drawSalesPurchasesChart(data) {
      const chartData = new google.visualization.DataTable();
      chartData.addColumn('string', 'Date');
      chartData.addColumn('number', 'Sales');
      chartData.addColumn('number', 'Revenue');
      Object.entries(data.timeline || {}).forEach(([date, d]) => {
        chartData.addRow([date, d.sales, d.revenue]);
      });
      const chart = new google.visualization.LineChart(document.getElementById('salesPurchasesChart'));
      chart.draw(chartData, { title: 'Sales & Revenue Over Time', height: 300 });
    }

    function drawRevenueBySupplierChart(data) {
      const chartData = new google.visualization.DataTable();
      chartData.addColumn('string', 'Supplier');
      chartData.addColumn('number', 'Revenue');
      data.revenueBySupplier.forEach(s => {
        chartData.addRow([s.supplier, s.revenue]);
      });
      const chart = new google.visualization.PieChart(document.getElementById('revenueBySupplierChart'));
      chart.draw(chartData, { title: 'Revenue by Supplier', height: 300 });
    }

    function drawTopSalesTable(items) {
      const dataTable = new google.visualization.DataTable();
      dataTable.addColumn('string', 'Item');
      dataTable.addColumn('number', 'Quantity');
      dataTable.addColumn('number', 'Sales');
      items.forEach(item => {
        dataTable.addRow([item.name, item.quantity, item.sales]);
      });
      const table = new google.visualization.Table(document.getElementById('topSalesTable'));
      table.draw(dataTable, { showRowNumber: true, width: '100%' });
    }

    function drawTopRevenueTable(items) {
      const dataTable = new google.visualization.DataTable();
      dataTable.addColumn('string', 'Item');
      dataTable.addColumn('number', 'Quantity');
      dataTable.addColumn('number', 'Revenue');
      items.forEach(item => {
        dataTable.addRow([item.name, item.quantity, item.revenue]);
      });
      const table = new google.visualization.Table(document.getElementById('topRevenueTable'));
      table.draw(dataTable, { showRowNumber: true, width: '100%' });
    }

    google.charts.setOnLoadCallback(fetchData);
  </script>
</body>
</html>



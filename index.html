<!DOCTYPE html>
<html>
<head>
  <title>Inventory Dashboard</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    body { font-family: Arial; margin: 20px; }
    .filter-group { margin-bottom: 15px; }
    .kpi-box { display: inline-block; margin-right: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; min-width: 120px; }
    .row { display: flex; flex-wrap: wrap; gap: 20px; }
    .column { flex: 1; min-width: 300px; }
    .chart-container { height: 400px; }
  </style>
</head>
<body>
  <h1>Inventory Dashboard</h1>

  <div class="filter-group">
    <label>View:</label>
    <select id="viewSelect">
      <option value="daily">Daily</option>
      <option value="weekly">Weekly</option>
      <option value="monthly" selected>Monthly</option>
    </select>

    <label>Start Date:</label>
    <input type="text" id="startDate">
    <label>End Date:</label>
    <input type="text" id="endDate">

    <label>Suppliers:</label>
    <select id="supplierSelect" multiple></select>

    <button onclick="loadDashboard()">Apply Filters</button>
  </div>

  <div class="row">
    <div class="kpi-box" id="totalSalesBox">Sales: 0</div>
    <div class="kpi-box" id="totalPurchasesBox">Purchases: 0</div>
    <div class="kpi-box" id="totalRevenueBox">Revenue: 0</div>
  </div>

  <div class="row">
    <div class="column chart-container" id="revenueChart"></div>
    <div class="column chart-container" id="salesPurchasesChart"></div>
  </div>

  <div class="row">
    <div class="column">
      <h3>Top Sales</h3>
      <ul id="topSalesList"></ul>
    </div>
    <div class="column">
      <h3>Top Revenue</h3>
      <ul id="topRevenueList"></ul>
    </div>
  </div>

  <div class="row">
    <div class="column">
      <h3>Total Sales per Supplier</h3>
      <ul id="salesPerSupplierList"></ul>
    </div>
    <div class="column">
      <h3>Total Purchases per Supplier</h3>
      <ul id="purchasesPerSupplierList"></ul>
    </div>
  </div>

  <script>
    google.charts.load('current', { packages: ['corechart'] });

    flatpickr("#startDate", { dateFormat: "Y-m-d" });
    flatpickr("#endDate", { dateFormat: "Y-m-d" });

    async function loadDashboard() {
      const view = document.getElementById("viewSelect").value;
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      const supplierSelect = document.getElementById("supplierSelect");
      const suppliers = Array.from(supplierSelect.selectedOptions).map(opt => opt.value);

      const params = new URLSearchParams({ view, startDate, endDate, supplier: suppliers.join(",") });

      const response = await fetch("https://script.google.com/macros/s/AKfycbxQ6X01gOsnohYlGqQ8dHDZDVmBEuAybaP7oqTr9HQX1HOE0apmaH9CAey9DqR4G10d/exec?" + params.toString());
      const data = await response.json();

      document.getElementById("totalSalesBox").innerText = `Sales: ${data.totals.sales.toFixed(2)}`;
      document.getElementById("totalPurchasesBox").innerText = `Purchases: ${data.totals.purchases.toFixed(2)}`;
      document.getElementById("totalRevenueBox").innerText = `Revenue: ${data.totals.revenue.toFixed(2)}`;

      drawDonutChart(data.revenueBySupplier);
      drawClusterChart(data.timeline);
      updateList("topSalesList", data.topSales, "sales");
      updateList("topRevenueList", data.topRevenue, "revenue");
      updateList("salesPerSupplierList", data.totalSalesPerSupplier, "sales");
      updateList("purchasesPerSupplierList", data.totalPurchasesPerSupplier, "purchases");
    }

    function drawDonutChart(data) {
      const chartData = google.visualization.arrayToDataTable([
        ["Supplier", "Revenue"],
        ...data.map(d => [d.supplier, d.revenue])
      ]);
      const chart = new google.visualization.PieChart(document.getElementById("revenueChart"));
      chart.draw(chartData, { title: "Revenue by Supplier", pieHole: 0.4 });
    }

    function drawClusterChart(timeline) {
      const chartData = google.visualization.arrayToDataTable([
        ["Period", "Sales", "Purchases"],
        ...Object.entries(timeline).map(([period, val]) => [period, val.sales, val.purchases])
      ]);
      const chart = new google.visualization.ColumnChart(document.getElementById("salesPurchasesChart"));
      chart.draw(chartData, { title: "Sales vs Purchases", isStacked: false });
    }

    function updateList(listId, data, valueKey) {
      const list = document.getElementById(listId);
      list.innerHTML = "";
      data.forEach(item => {
        const li = document.createElement("li");
        li.textContent = `${item.name || item.supplier}: ${item[valueKey].toFixed(2)}`;
        list.appendChild(li);
      });
    }

    async function loadSuppliers() {
      const res = await fetch("https://script.google.com/macros/s/YOUR_DEPLOYED_WEB_APP_URL/exec");
      const data = await res.json();
      const select = document.getElementById("supplierSelect");
      select.innerHTML = "";
      data.allSuppliers.forEach(s => {
        const option = document.createElement("option");
        option.value = s;
        option.textContent = s;
        select.appendChild(option);
      });
    }

    window.onload = async () => {
      await loadSuppliers();
      await loadDashboard();
    };
  </script>
</body>
</html>




<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
      const webUrl = "https://script.google.com/macros/s/AKfycbxQ6X01gOsnohYlGqQ8dHDZDVmBEuAybaP7oqTr9HQX1HOE0apmaH9CAey9DqR4G10d/exec"; // <-- Replace with your actual script ID

      google.charts.load("current", { packages: ["corechart"] });
      google.charts.setOnLoadCallback(loadData);

      async function loadData() {
        const view = document.getElementById("view").value;
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;
        const supplierOptions = Array.from(document.getElementById("supplier").options);
        const selectedSuppliers = supplierOptions.filter(o => o.selected).map(o => o.value).filter(v => v !== "All");
        const supplierParam = selectedSuppliers.length > 0 ? `&supplier=${selectedSuppliers.join(",")}` : "";

        const res = await fetch(`${webUrl}?view=${view}&startDate=${startDate}&endDate=${endDate}${supplierParam}`);
        const data = await res.json();

        drawTimelineChart(data.timeline);
        drawSupplierChart(data.revenueBySupplier);
        drawClusteredChart(data.summary); // NEW clustered chart
      }

      function drawTimelineChart(timeline) {
        const data = new google.visualization.DataTable();
        data.addColumn("string", "Date");
        data.addColumn("number", "Sales");
        data.addColumn("number", "Revenue");

        const sortedDates = Object.keys(timeline).sort();
        sortedDates.forEach(date => {
          const t = timeline[date];
          data.addRow([date, t.sales, t.revenue]);
        });

        const options = {
          title: "Sales vs Revenue Over Time",
          curveType: "function",
          legend: { position: "bottom" },
          colors: ["#3366CC", "#DC3912"]
        };

        const chart = new google.visualization.LineChart(document.getElementById("timeline_chart"));
        chart.draw(data, options);
      }

      function drawSupplierChart(revenueBySupplier) {
        const data = new google.visualization.DataTable();
        data.addColumn("string", "Supplier");
        data.addColumn("number", "Revenue");

        revenueBySupplier.forEach(item => {
          data.addRow([item.supplier, item.revenue]);
        });

        const options = {
          title: "Revenue by Supplier",
          pieHole: 0.4,
        };

        const chart = new google.visualization.PieChart(document.getElementById("supplier_chart"));
        chart.draw(data, options);
      }

      function drawClusteredChart(summary) {
        const data = new google.visualization.DataTable();
        data.addColumn("string", "Date");
        data.addColumn("number", "Sales");
        data.addColumn("number", "Purchases");

        const rows = summary.sales.map(sale => {
          const purchase = summary.purchases.find(p => p.date === sale.date);
          return [sale.date, sale.amount, purchase ? purchase.amount : 0];
        });

        data.addRows(rows);

        const options = {
          title: "Sales vs Purchases Over Time",
          chartArea: { width: "70%" },
          hAxis: {
            title: "Date",
            minValue: 0,
          },
          vAxis: {
            title: "Amount",
          },
          legend: { position: "bottom" },
          colors: ["#3366CC", "#FF9900"],
          bar: { groupWidth: "60%" },
          isStacked: false,
        };

        const chart = new google.visualization.ColumnChart(document.getElementById("clustered_chart"));
        chart.draw(data, options);
      }

      function selectAllSuppliers(checked) {
        const supplierSelect = document.getElementById("supplier");
        Array.from(supplierSelect.options).forEach(option => {
          option.selected = checked;
        });
        loadData();
      }
    </script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 10px;
        background: #f6f6f6;
      }
      .filter-section {
        margin-bottom: 20px;
      }
      .chart-row {
        display: flex;
        flex-wrap: nowrap;
        gap: 10px;
      }
      .chart-box {
        width: 33%;
        height: 400px;
        background: white;
        padding: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <div class="filter-section">
      <label for="view">Date View:</label>
      <select id="view" onchange="loadData()">
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly" selected>Monthly</option>
      </select>

      <label for="startDate">From:</label>
      <input type="date" id="startDate" onchange="loadData()" />

      <label for="endDate">To:</label>
      <input type="date" id="endDate" onchange="loadData()" />

      <label for="supplier">Suppliers:</label>
      <select id="supplier" multiple size="4" onchange="loadData()">
        <option value="All">Select All</option>
        <option value="ALEMART">ALEMART</option>
        <option value="CHIPS">CHIPS</option>
        <option value="CIG">CIG</option>
        <option value="CLOSET">CLOSET</option>
        <option value="Blank">Blank</option>
        <!-- Add more dynamically if needed -->
      </select>
      <label><input type="checkbox" onclick="selectAllSuppliers(this.checked)" /> Select All</label>
    </div>

    <div class="chart-row">
      <div class="chart-box" id="timeline_chart"></div>
      <div class="chart-box" id="supplier_chart"></div>
      <div class="chart-box" id="clustered_chart"></div>
    </div>
  </body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Inventory Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
    }
    .filters, .kpis, .charts, .lists {
      margin-bottom: 20px;
    }
    .supplier-dropdown {
      position: relative;
      display: inline-block;
    }
    .supplier-checkboxes {
      display: none;
      position: absolute;
      background-color: white;
      border: 1px solid #ccc;
      z-index: 1;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
    }
    .supplier-dropdown:hover .supplier-checkboxes {
      display: block;
    }
    .chart-container {
      display: flex;
      gap: 20px;
      height: 400px;
    }
    canvas {
      background: #f4f4f4;
      border-radius: 8px;
      padding: 10px;
    }
    .lists {
      display: flex;
      gap: 20px;
    }
    .list {
      flex: 1;
    }
  </style>
</head>
<body>

  <h2>Inventory Dashboard</h2>

  <div class="filters">
    <label for="viewSelect">View:</label>
    <select id="viewSelect">
      <option value="monthly">Monthly</option>
      <option value="weekly">Weekly</option>
      <option value="daily">Daily</option>
    </select>

    <label for="startDate">Start Date:</label>
    <input type="date" id="startDate">
    <label for="endDate">End Date:</label>
    <input type="date" id="endDate">

    <div class="supplier-dropdown">
      <button id="supplierBtn">Select Suppliers</button>
      <div class="supplier-checkboxes" id="supplierCheckboxes">
        <label><input type="checkbox" id="selectAllSuppliers"> Select All</label><br>
        <!-- Suppliers loaded dynamically -->
      </div>
    </div>

    <button onclick="loadDashboard()">Apply Filters</button>
  </div>

  <div class="kpis">
    <p>Total Sales: <span id="salesKPI"></span></p>
    <p>Total Purchases: <span id="purchasesKPI"></span></p>
    <p>Total Revenue: <span id="revenueKPI"></span></p>
  </div>

  <div class="chart-container">
    <canvas id="revenueBySupplierChart"></canvas>
    <canvas id="salesPurchasesChart"></canvas>
  </div>

  <div class="lists">
    <div class="list">
      <h3>Top Sales</h3>
      <ul id="topSalesList"></ul>
    </div>
    <div class="list">
      <h3>Top Revenue</h3>
      <ul id="topRevenueList"></ul>
    </div>
  </div>

  <div class="lists">
    <div class="list">
      <h3>Total Sales Per Supplier</h3>
      <ul id="salesPerSupplierList"></ul>
    </div>
    <div class="list">
      <h3>Total Purchases Per Supplier</h3>
      <ul id="purchasesPerSupplierList"></ul>
    </div>
  </div>

<script>
const backendUrl = 'https://script.google.com/macros/s/AKfycbxQ6X01gOsnohYlGqQ8dHDZDVmBEuAybaP7oqTr9HQX1HOE0apmaH9CAey9DqR4G10d/exec'; // <-- Replace

let revenueChart, barChart;

function getSelectedSuppliers() {
  const checkboxes = document.querySelectorAll('.supplier-checkboxes input[type="checkbox"]:not(#selectAllSuppliers)');
  return Array.from(checkboxes)
    .filter(cb => cb.checked)
    .map(cb => cb.value);
}

function setupSupplierFilter(suppliers) {
  const container = document.getElementById('supplierCheckboxes');
  container.innerHTML = `<label><input type="checkbox" id="selectAllSuppliers"> Select All</label><br>`;
  suppliers.forEach(supplier => {
    const checkbox = document.createElement('label');
    checkbox.innerHTML = `<input type="checkbox" value="${supplier}"> ${supplier}<br>`;
    container.appendChild(checkbox);
  });

  // Select all toggle
  document.getElementById('selectAllSuppliers').addEventListener('change', function() {
    const checked = this.checked;
    document.querySelectorAll('.supplier-checkboxes input[type="checkbox"]:not(#selectAllSuppliers)').forEach(cb => {
      cb.checked = checked;
    });
  });
}

function loadDashboard() {
  const view = document.getElementById('viewSelect').value;
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const suppliers = getSelectedSuppliers().join(',');

  const params = new URLSearchParams({ view, startDate, endDate, supplier: suppliers });
  fetch(`${backendUrl}?${params.toString()}`)
    .then(res => res.json())
    .then(data => renderDashboard(data))
    .catch(err => console.error('Error loading dashboard:', err));
}

function renderDashboard(data) {
  document.getElementById('salesKPI').textContent = data.totals.sales.toFixed(2);
  document.getElementById('purchasesKPI').textContent = data.totals.purchases.toFixed(2);
  document.getElementById('revenueKPI').textContent = data.totals.revenue.toFixed(2);

  renderRevenueChart(data.revenueBySupplier);
  renderSalesPurchasesChart(data.timeline);
  renderList('topSalesList', data.topSales, 'sales');
  renderList('topRevenueList', data.topRevenue, 'revenue');

  const salesMap = {};
  data.topSales.forEach(item => salesMap[item.name] = item.sales);

  const purchasesMap = {};
  data.topRevenue.forEach(item => purchasesMap[item.name] = item.revenue);

  renderSupplierList('salesPerSupplierList', data.revenueBySupplier, 'revenue');
  renderSupplierList('purchasesPerSupplierList', data.revenueBySupplier, 'revenue');
}

function renderRevenueChart(data) {
  const ctx = document.getElementById('revenueBySupplierChart').getContext('2d');
  if (revenueChart) revenueChart.destroy();
  revenueChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: data.map(d => d.supplier),
      datasets: [{
        label: 'Revenue',
        data: data.map(d => d.revenue),
        backgroundColor: data.map((_, i) => `hsl(${i * 30}, 70%, 60%)`)
      }]
    }
  });
}

function renderSalesPurchasesChart(data) {
  const ctx = document.getElementById('salesPurchasesChart').getContext('2d');
  if (barChart) barChart.destroy();
  const labels = Object.keys(data);
  const sales = labels.map(k => data[k].sales);
  const purchases = labels.map(k => data[k].purchases);

  barChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Sales', data: sales, backgroundColor: 'blue' },
        { label: 'Purchases', data: purchases, backgroundColor: 'orange' }
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: { stacked: false },
        y: { beginAtZero: true }
      }
    }
  });
}

function renderList(elementId, items, field) {
  const list = document.getElementById(elementId);
  list.innerHTML = '';
  items.forEach(item => {
    const li = document.createElement('li');
    li.textContent = `${item.name}: ${item[field].toFixed(2)}`;
    list.appendChild(li);
  });
}

function renderSupplierList(elementId, items, field) {
  const list = document.getElementById(elementId);
  list.innerHTML = '';
  items.forEach(item => {
    const li = document.createElement('li');
    li.textContent = `${item.supplier}: ${item[field].toFixed(2)}`;
    list.appendChild(li);
  });
}

// Initial load to populate supplier filter
fetch(backendUrl)
  .then(res => res.json())
  .then(data => setupSupplierFilter(data.allSuppliers))
  .catch(err => console.error('Error loading suppliers:', err));
</script>

</body>
</html>

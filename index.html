<!DOCTYPE html>
<html>
<head>
  <title>Inventory Dashboard</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    label {
      font-weight: bold;
    }
    .dropdown {
      position: relative;
      display: inline-block;
      margin-bottom: 10px;
    }
    .dropbtn {
      padding: 8px 12px;
      cursor: pointer;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #fff;
      min-width: 200px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      z-index: 10;
    }
    .dropdown-content label {
      display: block;
      padding: 5px 10px;
      cursor: pointer;
    }
    .kpi { margin: 10px 0; }
    table { width: 100%; border-collapse: collapse; margin: 10px 0; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
  </style>
</head>
<body>
  <div class="filter-section">
    <label for="startDate">Start Date:</label>
    <input type="date" id="startDate">
    <label for="endDate">End Date:</label>
    <input type="date" id="endDate">

    <div class="dropdown">
      <button class="dropbtn" onclick="toggleDropdown()">Select Suppliers</button>
      <div id="supplierDropdown" class="dropdown-content"></div>
    </div>
    <button onclick="selectAllSuppliers()">Select All</button>
    <button onclick="loadDashboard()">Apply Filters</button>
  </div>

  <div class="kpi">
    <strong>Total Sales:</strong> <span id="totalSales">₱0.00</span><br>
    <strong>Total Purchases:</strong> <span id="totalPurchases">₱0.00</span><br>
    <strong>Total Revenue:</strong> <span id="totalRevenue">₱0.00</span>
  </div>

  <div id="timelineChart" style="width: 100%; height: 300px;"></div>
  <div id="monthlyChart" style="width: 100%; height: 300px;"></div>
  <div id="revenueBySupplierChart" style="width: 100%; height: 300px;"></div>

  <h3>Top Sales</h3>
  <div id="topSalesTable"></div>

  <h3>Top Revenue</h3>
  <div id="topRevenueTable"></div>

  <h3>Supplier Summary</h3>
  <div id="supplierSummary"></div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxQ6X01gOsnohYlGqQ8dHDZDVmBEuAybaP7oqTr9HQX1HOE0apmaH9CAey9DqR4G10d/exec';

    google.charts.load('current', {packages: ['corechart']});

    function toggleDropdown() {
      const dropdown = document.getElementById('supplierDropdown');
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }

    function populateSupplierFilter(suppliers, selected = []) {
      const dropdown = document.getElementById('supplierDropdown');
      dropdown.innerHTML = '';
      suppliers.forEach(supplier => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = supplier;
        checkbox.checked = selected.length === 0 || selected.includes(supplier);
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(" " + supplier));
        dropdown.appendChild(label);
      });
    }

    function getSelectedSuppliers() {
      const checkboxes = document.querySelectorAll('#supplierDropdown input[type="checkbox"]');
      return Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
    }

    function selectAllSuppliers() {
      document.querySelectorAll('#supplierDropdown input[type="checkbox"]').forEach(cb => cb.checked = true);
    }

    function formatCurrency(value) {
      return '₱' + Number(value).toLocaleString('en-PH', { minimumFractionDigits: 2 });
    }

    function updateKPIs(totals) {
      document.getElementById('totalSales').textContent = totals.sales;
      document.getElementById('totalPurchases').textContent = totals.purchases;
      document.getElementById('totalRevenue').textContent = totals.revenue;
    }

    function drawTimeline(data) {
      const chartData = [['Date', 'Sales']];
      data.forEach(row => chartData.push([row.label, row.value]));
      const dataTable = google.visualization.arrayToDataTable(chartData);
      const chart = new google.visualization.LineChart(document.getElementById('timelineChart'));
      chart.draw(dataTable, { title: 'Sales Timeline', curveType: 'function', legend: { position: 'bottom' } });
    }

    function drawSalesPurchases(data) {
      const chartData = [['Month', 'Sales', 'Purchases']];
      data.forEach(row => chartData.push([row.label, row.sales, row.purchases]));
      const dataTable = google.visualization.arrayToDataTable(chartData);
      const chart = new google.visualization.ColumnChart(document.getElementById('monthlyChart'));
      chart.draw(dataTable, { title: 'Sales vs Purchases', legend: { position: 'bottom' } });
    }

    function drawRevenueBySupplier(data) {
      const chartData = [['Supplier', 'Revenue']];
      data.forEach(row => chartData.push([row.supplier, row.revenue]));
      const dataTable = google.visualization.arrayToDataTable(chartData);
      const chart = new google.visualization.PieChart(document.getElementById('revenueBySupplierChart'));
      chart.draw(dataTable, { title: 'Revenue by Supplier' });
    }

    function populateTable(containerId, data, columns) {
      const container = document.getElementById(containerId);
      if (!data.length) {
        container.innerHTML = "<em>No data</em>";
        return;
      }
      let html = "<table><thead><tr>" + columns.map(col => `<th>${col}</th>`).join('') + "</tr></thead><tbody>";
      html += data.map(row => "<tr>" + columns.map(col => `<td>${row[col]}</td>`).join('') + "</tr>").join('');
      html += "</tbody></table>";
      container.innerHTML = html;
    }

    function loadDashboard() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const selectedSuppliers = getSelectedSuppliers();
      const url = `${scriptURL}?startDate=${startDate}&endDate=${endDate}&supplier=${encodeURIComponent(JSON.stringify(selectedSuppliers))}`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (data.error) return alert('Error: ' + data.error);
          updateKPIs(data.totals);
          drawTimeline(data.timeline);
          drawSalesPurchases(data.monthly);
          drawRevenueBySupplier(data.revenueBySupplier);
          populateTable('topSalesTable', data.topSales, ['name', 'quantity', 'sales']);
          populateTable('topRevenueTable', data.topRevenue, ['name', 'quantity', 'revenue']);
          populateTable('supplierSummary', data.supplierSummary, ['supplier', 'sales', 'purchases']);
          populateSupplierFilter(data.allSuppliers, selectedSuppliers);
        })
        .catch(err => {
          console.error('Error loading data:', err);
          alert('Failed to load dashboard data.');
        });
    }

    window.onload = function () {
      const startInput = document.getElementById('startDate');
      const endInput = document.getElementById('endDate');
      startInput.value = '2025-01-01';
      endInput.value = new Date().toISOString().split('T')[0];
      loadDashboard();
    };
  </script>
</body>
</html>
